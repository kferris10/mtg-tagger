<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Tagger</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 2rem;
        }
        .dashboard {
            display: grid;
            grid-template-columns: minmax(360px, 38%) 1fr;
            gap: 2.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }
        .left-panel {
            position: sticky;
            top: 2rem;
            align-self: flex-start;
        }
        .right-panel {
            position: relative;
            min-height: 300px;
        }
        .right-panel.loading {
            opacity: 0.5;
            pointer-events: none;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.25rem;
            color: #c9a959;
        }
        .subtitle {
            color: #888;
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
        }
        input, textarea {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid #333;
            border-radius: 6px;
            background: #16213e;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.95rem;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #c9a959;
        }
        textarea { resize: vertical; min-height: 160px; }
        .field { margin-bottom: 1.2rem; }
        button {
            background: #c9a959;
            color: #1a1a2e;
            border: none;
            padding: 0.7rem 1.6rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
        }
        button:hover { background: #d4b96a; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Loading bar */
        .loading-bar {
            height: 3px;
            background: #333;
            border-radius: 2px;
            margin-top: 0.75rem;
            overflow: hidden;
            visibility: hidden;
        }
        .loading-bar.visible { visibility: visible; }
        .loading-bar::after {
            content: "";
            display: block;
            width: 30%;
            height: 100%;
            background: #c9a959;
            border-radius: 2px;
            animation: loading-slide 1.2s ease-in-out infinite;
        }
        @keyframes loading-slide {
            0%   { transform: translateX(-100%); }
            100% { transform: translateX(433%); }
        }

        /* Error toast */
        .error-toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            max-width: 400px;
            padding: 0.8rem 2.5rem 0.8rem 1rem;
            background: #3a1a1a;
            border: 1px solid #a33;
            border-radius: 6px;
            color: #f88;
            font-size: 0.9rem;
            z-index: 100;
            transform: translateX(calc(100% + 2rem));
            transition: transform 0.3s ease;
        }
        .error-toast.visible {
            animation: toast-slide-in 0.3s ease forwards;
        }
        @keyframes toast-slide-in {
            from { transform: translateX(calc(100% + 2rem)); }
            to   { transform: translateX(0); }
        }
        .error-dismiss {
            position: absolute;
            top: 0.5rem;
            right: 0.6rem;
            background: none;
            border: none;
            color: #f88;
            font-size: 1rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            font-weight: 400;
        }
        .error-dismiss:hover { color: #faa; background: none; }

        /* Empty state */
        .empty-state {
            color: #555;
            font-style: italic;
            text-align: center;
            padding-top: 6rem;
            font-size: 1rem;
        }
        .empty-state.hidden { display: none; }

        .results {
            display: none;
        }
        .results.visible { display: block; }
        .results h2 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #c9a959;
        }
        pre {
            background: #16213e;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 1rem;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        .results-table th,
        .results-table td {
            text-align: left;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #333;
        }
        .results-table th {
            color: #c9a959;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .results-table td { font-size: 0.95rem; }
        .sort-header {
            cursor: pointer;
            user-select: none;
        }
        .sort-header:hover { color: #d4b96a; }
        .sort-arrow {
            font-size: 0.75rem;
            margin-left: 0.3rem;
        }
        .badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 0.4rem;
            margin-bottom: 0.3rem;
        }
        .badge-s  { background: #a08520; color: #fff; }
        .badge-a  { background: #2e7d32; color: #fff; }
        .badge-b  { background: #1565c0; color: #fff; }
        .badge-c  { background: #555;    color: #ccc; }
        .badge-d  { background: #8b1a1a; color: #fff; }
        .category-counts {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            position: sticky;
            top: 0;
            background: #1a1a2e;
            padding: 0.5rem 0;
            z-index: 10;
            border-bottom: 1px solid #333;
        }
        .count-chip {
            background: #16213e;
            border: 1px solid #333;
            border-radius: 999px;
            padding: 0.3rem 0.8rem;
            font-size: 0.85rem;
            color: #c9a959;
        }
        .muted { color: #666; font-style: italic; font-size: 0.9rem; }
        .raw-toggle {
            background: none;
            border: none;
            color: #c9a959;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
            font-weight: 600;
            margin-top: 1rem;
            display: inline-block;
        }
        .raw-toggle:hover { text-decoration: underline; background: none; }
        .raw-json { display: none; margin-top: 0.5rem; }
        .raw-json.visible { display: block; }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; gap: 1.5rem; }
            .left-panel { position: static; }
            .category-counts { position: static; }
            .error-toast { left: 1rem; right: 1rem; max-width: none; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="left-panel">
            <h1>MTG Tagger</h1>
            <p class="subtitle">Analyze Magic: The Gathering cards for Commander mechanics and tier ratings</p>

            <div class="field">
                <label for="card-data">Card Data</label>
                <textarea id="card-data" placeholder="Name: Sol Ring. Text: {T}: Add {C}{C}.
Name: Cyclonic Rift. Text: Return target nonland permanent you don't control to its owner's hand. Overload {6}{U}"></textarea>
            </div>

            <button id="submit-btn">Analyze Cards</button>
            <div class="loading-bar" id="loading"></div>
        </div>

        <div class="right-panel" id="right-panel">
            <div class="empty-state" id="empty-state">Submit cards to see results</div>
            <div class="error-toast" id="error">
                <button class="error-dismiss" id="error-dismiss">&times;</button>
                <span id="error-msg"></span>
            </div>
            <div class="results" id="results">
                <h2>Results</h2>
                <div id="results-table"></div>
                <button class="raw-toggle" id="raw-toggle">Show raw JSON</button>
                <div class="raw-json" id="raw-json">
                    <pre id="results-content"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const btn = document.getElementById("submit-btn");
        const loading = document.getElementById("loading");
        const errorEl = document.getElementById("error");
        const errorMsg = document.getElementById("error-msg");
        const errorDismiss = document.getElementById("error-dismiss");
        const resultsEl = document.getElementById("results");
        const resultsContent = document.getElementById("results-content");
        const resultsTable = document.getElementById("results-table");
        const rawToggle = document.getElementById("raw-toggle");
        const rawJson = document.getElementById("raw-json");
        const rightPanel = document.getElementById("right-panel");
        const emptyState = document.getElementById("empty-state");

        let errorTimer = null;

        const MECHANIC_LABELS = {
            ramp: "Ramp",
            card_advantage: "Card Advantage",
            targeted_disruption: "Targeted Disruption",
            mass_disruption: "Mass Disruption",
            go_wide: "Go Wide",
            anthem: "Anthem",
            overrun: "Overrun"
        };

        rawToggle.addEventListener("click", () => {
            rawJson.classList.toggle("visible");
            rawToggle.textContent = rawJson.classList.contains("visible")
                ? "Hide raw JSON" : "Show raw JSON";
        });

        function dismissError() {
            errorEl.classList.remove("visible");
            if (errorTimer) { clearTimeout(errorTimer); errorTimer = null; }
        }

        errorDismiss.addEventListener("click", dismissError);
        errorEl.addEventListener("click", dismissError);

        function esc(str) {
            const d = document.createElement("div");
            d.textContent = str;
            return d.innerHTML;
        }

        function tierBadgeClass(tier) {
            const t = tier.toLowerCase();
            if (t.startsWith("s"))  return "badge-s";
            if (t.startsWith("a"))  return "badge-a";
            if (t.startsWith("b"))  return "badge-b";
            if (t.startsWith("c"))  return "badge-c";
            if (t.startsWith("d"))  return "badge-d";
            return "badge-c";
        }

        function tierRank(tier) {
            const t = tier.toLowerCase().replace(/[- ]?tier$/i, "").trim();
            const ranks = {"s+": 0, "s": 1, "a": 2, "b": 3, "c": 4, "d": 5};
            return ranks[t] !== undefined ? ranks[t] : 6;
        }

        function renderResults(data) {
            // If the API returned a plain string, show it as raw text
            if (typeof data === "string") {
                try {
                    data = JSON.parse(data);
                } catch {
                    resultsTable.innerHTML = `<pre>${data}</pre>`;
                    resultsContent.textContent = data;
                    rawJson.classList.remove("visible");
                    rawToggle.textContent = "Show raw JSON";
                    return;
                }
            }
            const result = data;

            // Build flat rows array
            const rows = [];
            let noMechCount = 0;
            for (const [cardName, mechanics] of Object.entries(result)) {
                const mechEntries = Object.entries(mechanics);
                if (mechEntries.length === 0) {
                    noMechCount++;
                } else {
                    for (const [mech, tier] of mechEntries) {
                        rows.push({
                            card: cardName,
                            mechanic: mech,
                            mechanicLabel: MECHANIC_LABELS[mech] || mech,
                            tier: tier,
                            tierRankVal: tierRank(tier)
                        });
                    }
                }
            }

            // Category counts
            const counts = {};
            for (const row of rows) {
                counts[row.mechanicLabel] = (counts[row.mechanicLabel] || 0) + 1;
            }
            const countsSorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);

            // Sort state
            let sortCol = "tier";
            let sortAsc = true; // ascending tierRank = strongest first

            function sortRows() {
                rows.sort((a, b) => {
                    let cmp = 0;
                    if (sortCol === "card") {
                        cmp = a.card.localeCompare(b.card);
                    } else if (sortCol === "mechanic") {
                        cmp = a.mechanicLabel.localeCompare(b.mechanicLabel);
                    } else {
                        cmp = a.tierRankVal - b.tierRankVal;
                    }
                    return sortAsc ? cmp : -cmp;
                });
            }

            function renderTable() {
                sortRows();
                const arrow = sortAsc ? "▲" : "▼";
                const thCard = `Card${sortCol === "card" ? ' <span class="sort-arrow">' + arrow + '</span>' : ''}`;
                const thMech = `Mechanic${sortCol === "mechanic" ? ' <span class="sort-arrow">' + arrow + '</span>' : ''}`;
                const thTier = `Tier${sortCol === "tier" ? ' <span class="sort-arrow">' + arrow + '</span>' : ''}`;

                let html = '<div class="category-counts">';
                for (const [label, count] of countsSorted) {
                    html += `<span class="count-chip">${esc(label)}: ${count}</span>`;
                }
                html += '</div>';
                html += '<table class="results-table"><thead><tr>';
                html += `<th class="sort-header" data-col="card">${thCard}</th>`;
                html += `<th class="sort-header" data-col="mechanic">${thMech}</th>`;
                html += `<th class="sort-header" data-col="tier">${thTier}</th>`;
                html += '</tr></thead><tbody>';

                for (const row of rows) {
                    const cls = tierBadgeClass(row.tier);
                    html += `<tr><td>${esc(row.card)}</td><td>${esc(row.mechanicLabel)}</td><td><span class="badge ${cls}">${esc(row.tier)}</span></td></tr>`;
                }
                html += '</tbody></table>';

                if (noMechCount > 0) {
                    html += `<p class="muted">${noMechCount} card${noMechCount === 1 ? '' : 's'} had no tagged mechanics</p>`;
                }

                resultsTable.innerHTML = html;

                // Attach sort handlers
                resultsTable.querySelectorAll(".sort-header").forEach(th => {
                    th.addEventListener("click", () => {
                        const col = th.getAttribute("data-col");
                        if (sortCol === col) {
                            sortAsc = !sortAsc;
                        } else {
                            sortCol = col;
                            sortAsc = true;
                        }
                        renderTable();
                    });
                });
            }

            renderTable();

            // Raw JSON
            resultsContent.textContent = JSON.stringify(result, null, 2);
            rawJson.classList.remove("visible");
            rawToggle.textContent = "Show raw JSON";
        }

        btn.addEventListener("click", async () => {
            const cardData = document.getElementById("card-data").value.trim();

            if (!cardData) {
                showError("Please enter card data.");
                return;
            }

            btn.disabled = true;
            loading.classList.add("visible");
            rightPanel.classList.add("loading");
            dismissError();
            resultsEl.classList.remove("visible");

            const body = { card_data: cardData };

            try {
                const res = await fetch("/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body),
                });

                const data = await res.json();

                if (!res.ok) {
                    showError(data.error || "An unexpected error occurred.");
                    return;
                }

                emptyState.classList.add("hidden");
                renderResults(data.result);
                resultsEl.classList.add("visible");
            } catch (e) {
                if (e instanceof TypeError || e instanceof SyntaxError) {
                    showError("Error rendering results: " + e.message);
                } else {
                    showError("Network error: could not reach the server.");
                }
            } finally {
                btn.disabled = false;
                loading.classList.remove("visible");
                rightPanel.classList.remove("loading");
            }
        });

        function showError(msg) {
            errorMsg.textContent = msg;
            errorEl.classList.add("visible");
            if (errorTimer) clearTimeout(errorTimer);
            errorTimer = setTimeout(() => {
                errorEl.classList.remove("visible");
                errorTimer = null;
            }, 5000);
        }
    </script>
</body>
</html>
